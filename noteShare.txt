Write-Output "Getting environment info..."
$environment = m365 flow environment list --query '[?properties.isDefault==`true`].name' --output json | ConvertFrom-JSON

Write-Output "Getting Flows info..."
$flows = m365 flow list --environmentName $environment --asAdmin --output json | ConvertFrom-JSON

$total = $flows.Count
Write-Output "Found $($total) Flows to export..."


$folder = "ExportedFlows"
$filename = "ErrorLog.txt"
$exportErrorPath = Join-Path $folder "$filename`_$timestamp"


$i = 0
foreach ($f in $flows) {
    $i++
    $flowId = $f.name
    $displayName = $f.properties.displayName

    $filename = $f.properties.displayName.Replace(" ","")
    $timestamp = Get-Date -Format "yyyymmddhhmmss"
    $exportPath = Join-Path $folder "$filename`_$timestamp"

    $percent = [int](($i / $total) * 100)
    Write-Progress -Activity "Adding co-owner to flows" -Status "Processing $i of $($total): $displayName" -PercentComplete $percent

    try {
        m365 flow owner ensure --environmentName $environment --flowName $flowId --userName "PowerAutomate_Admin@test.onmicrosoft.com" --roleName CanEdit --asAdmin
        Start-Sleep -Seconds 1
    }
    catch {
        $message = $($_.Exception.Message) -replace "`r`n"," " -replace "`n"," " -replace "`t"," "
        $errLine = "Error in $displayName / $flowId : $message"
        $errLine | Out-File -FilePath $exportErrorPath -Append -Encoding utf8
    }
}

Write-Progress -Activity "Adding co-owner to flows" -Completed









'''
$flows | ForEach-Object {
    Write-Output "Exporting as ZIP & JSON... $($_.displayName)"
    $filename = $_.properties.displayName.Replace(" ","")
    $timestamp = Get-Date -Format "yyyymmddhhmmss"
    $folder = "ExportedFlows"
    $exportPath = Join-Path $folder "$filename`_$timestamp"
    $flowId = $_.name
    
    try{
        m365 flow export --name $flowId --environmentName $environment --packageDisplayName $_.properties.displayName --path "$exportPath.zip"
        m365 flow export --name $flowId --environmentName $environment --format json --path "$exportPath.json"
    }
    catch{
        m365 flow export --name $flowId --environmentName $environment --packageDisplayName $_.properties.displayName --path "$exportPath.zip"
        m365 flow export --name $flowId --environmentName $environment --format json --path "$exportPath.json"
    }
    
}

Write-Output "Complete"
'''






$environment = "Default"
$targetUser  = "PowerAutomate_Admin@test.onmicrosoft.com"
$exportPath  = Join-Path $PWD "ExportedFlows\errors.txt"

# ensure export folder exists
$exportDir = Split-Path -Path $exportPath -Parent
if (-not (Test-Path $exportDir)) { New-Item -Path $exportDir -ItemType Directory -Force | Out-Null }

$flows = m365 flow list --environmentName $environment --asAdmin --output json | ConvertFrom-Json
$total = $flows.Count
if ($total -eq 0) { Write-Host "No flows found in environment $environment"; return }

# Progress tracking
$startTime = Get-Date
$i = 0
$successCount = 0
$failureCount = 0
$lastError = ""

foreach ($f in $flows) {
    $i++
    $flowId = $f.name
    $displayName = $f.properties.displayName

    # compute progress metrics
    $percent = [int](($i / $total) * 100)
    $elapsed = (Get-Date) - $startTime
    $avgPerItem = if ($i -gt 0) { [math]::Round($elapsed.TotalSeconds / $i, 2) } else { 0 }
    $remainingItems = $total - $i
    $etaSeconds = [math]::Round($avgPerItem * $remainingItems)
    $eta = (Get-Date).AddSeconds($etaSeconds)

    # Main progress (single-line summary)
    Write-Progress -Id 1 `
                   -Activity "Adding co-owner to flows" `
                   -Status "Processed $i of $total ($percent%) â€” Success: $successCount  Failures: $failureCount" `
                   -PercentComplete $percent

    # Detailed progress (second line with ETA and current flow)
    $detailStatus = "Current: $displayName  |  FlowId: $flowId"
    $detailStatus += "  |  Elapsed: $([math]::Round($elapsed.TotalMinutes,2))m"
    $detailStatus += "  |  Avg/item: ${avgPerItem}s  |  ETA: $($eta.ToString('yyyy-MM-dd HH:mm:ss'))"
    if ($lastError) { $detailStatus += "  |  LastError: $lastError" }

    Write-Progress -Id 2 `
                   -Activity "Details" `
                   -Status $detailStatus `
                   -PercentComplete $percent

    try {
        m365 flow owner ensure --environmentName $environment --flowName $flowId --userName $targetUser --roleName CanEdit --asAdmin
        $successCount++
        $lastError = ""
    } catch {
        $failureCount++
        $message = $($_.Exception.Message) -replace "`r`n"," " -replace "`n"," " -replace "`t"," "
        $lastError = $message
        $errLine = "Error in $displayName / $flowId : $message"
        $errLine | Out-File -FilePath $exportPath -Append -Encoding utf8
    }

    Start-Sleep -Seconds 1
}

# Complete progress bars
Write-Progress -Id 1 -Activity "Adding co-owner to flows" -Completed
Write-Progress -Id 2 -Activity "Details" -Completed

Write-Host "Done. Total: $total  Success: $successCount  Failures: $failureCount"
if ($failureCount -gt 0) { Write-Host "See errors: $exportPath" }





B:
$environment = "Default"
$targetUser  = "PowerAutomate_Admin@test.onmicrosoft.com"
$exportPath  = Join-Path $PWD "ExportedFlows\errors.txt"

# ensure export folder exists
$exportDir = Split-Path -Path $exportPath -Parent
if (-not (Test-Path $exportDir)) { New-Item -Path $exportDir -ItemType Directory -Force | Out-Null }

$flows = m365 flow list --environmentName $environment --asAdmin --output json | ConvertFrom-Json
$total = $flows.Count
if ($total -eq 0) { Write-Host "No flows found in environment $environment"; return }

$i = 0
$successCount = 0
$failureCount = 0
foreach ($f in $flows) {
    $i++
    $flowId = $f.name
    $displayName = $f.properties.displayName

    $percent = [int](($i / $total) * 100)
    Write-Progress -Activity "Adding co-owner to flows" -Status "Processing $i of $($total): $displayName" -PercentComplete $percent

    $argString = "flow owner ensure --environmentName `"$environment`" --flowName `"$flowId`" --userName `"$targetUser`" --roleName CanEdit --asAdmin"
    $proc = Start-Process -FilePath "m365" -ArgumentList $argString -NoNewWindow -Wait -PassThru -RedirectStandardOutput ([System.IO.Path]::GetTempFileName()) -RedirectStandardError ([System.IO.Path]::GetTempFileName())

    $stdout = Get-Content -Path $proc.StandardOutput -Raw -ErrorAction SilentlyContinue
    $stderr = Get-Content -Path $proc.StandardError -Raw -ErrorAction SilentlyContinue

    if ($proc.ExitCode -ne 0) {
        $failureCount++
        $msg = if ($stderr) { $stderr } else { $stdout }
        $errLine = "Error in $displayName / $flowId : $msg"
        $errLine | Out-File -FilePath $exportPath -Append -Encoding utf8
    } else {
        $successCount++
    }

    Start-Sleep -Seconds 1
}

Write-Progress -Activity "Adding co-owner to flows" -Completed
Write-Host "Done. Total: $total  Success: $successCount  Failures: $failureCount"
if ($failureCount -gt 0) { Write-Host "See errors: $exportPath" }





A:
$environment = "Default"
$targetUser  = "PowerAutomate_Admin@test.onmicrosoft.com"
$exportPath  = Join-Path $PWD "ExportedFlows\errors.txt"

# ensure export folder exists
$exportDir = Split-Path -Path $exportPath -Parent
if (-not (Test-Path $exportDir)) { New-Item -Path $exportDir -ItemType Directory -Force | Out-Null }

$flows = m365 flow list --environmentName $environment --asAdmin --output json | ConvertFrom-Json
$total = $flows.Count
if ($total -eq 0) { Write-Host "No flows found in environment $environment"; return }

$i = 0
$successCount = 0
$failureCount = 0
foreach ($f in $flows) {
    $i++
    $flowId = $f.name
    $displayName = $f.properties.displayName

    $percent = [int](($i / $total) * 100)
    Write-Progress -Activity "Adding co-owner to flows" -Status "Processing $i of $($total): $displayName" -PercentComplete $percent

    # Run m365 and capture both stdout and stderr
    $args = @(
      "flow", "owner", "ensure",
      "--environmentName", $environment,
      "--flowName", $flowId,
      "--userName", $targetUser,
      "--roleName", "CanEdit",
      "--asAdmin"
    )
    $output = & m365 @args 2>&1
    if ($LASTEXITCODE -ne 0) {
        $failureCount++
        $msg = $output -join "`n"
        $errLine = "Error in $displayName / $flowId : $msg"
        $errLine | Out-File -FilePath $exportPath -Append -Encoding utf8
    } else {
        $successCount++
    }

    Start-Sleep -Seconds 1
}

Write-Progress -Activity "Adding co-owner to flows" -Completed
Write-Host "Done. Total: $total  Success: $successCount  Failures: $failureCount"
if ($failureCount -gt 0) { Write-Host "See errors: $exportPath" }

