# Stop on all errors so they go into the catch block
$ErrorActionPreference = 'Stop'

try {
    ### Get Teams Report ###
    Connect-MicrosoftTeams

    $all  = @()
    $top  = 500
    $skip = 0

    do {
        $page  = Get-CsPhoneNumberAssignment -Top $top -Skip $skip -ErrorAction Stop
        $count = $page.Count
        if ($count -gt 0) { $all += $page }
        $skip += $count
    } while ($count -ge $top)

    # Columns to select
    $ColumnMap = @{
        ActivationState         = $false
        AssignedPstnTargetId    = $true
        AssignmentCategory      = $true
        Capability              = $false
        City                    = $true
        CivicAddressId          = $true
        IsoCountryCode          = $false
        IsoSubdivision          = $true
        LocationId              = $true
        LocationUpdateSupported = $false
        NetworkSiteId           = $false
        NumberSource            = $false
        NumberType              = $true
        OperatorId              = $false
        PortInOrderStatus       = $true
        PstnAssignmentStatus    = $true
        PstnPartnerId           = $false
        PstnPartnerName         = $false
        ReverseNumberLookup     = $false
        TelephoneNumber         = $true
    }

    $SelectedColumns = $ColumnMap.GetEnumerator() |
        Where-Object { $_.Value -eq $true } |
        Select-Object -ExpandProperty Key

    $all = $all | Select-Object $SelectedColumns

    ### Enrich with user details ###
    Connect-MgGraph

    $UserIds = $all.AssignedPstnTargetId |
        Where-Object { $_ } |
        Select-Object -Unique

    $UserLookup = foreach ($id in $UserIds) {
        Get-MgUser -UserId $id -ErrorAction SilentlyContinue |
            Select-Object Id, DisplayName, UserPrincipalName
    }

    $UserTable = $UserLookup | Group-Object -Property Id -AsHashTable -AsString

    $Enriched = $all | Select-Object *,
        @{ Name = 'UserDisplayName'; Expression = { $UserTable[$_.AssignedPstnTargetId.ToString()].DisplayName } },
        @{ Name = 'UserEmail';       Expression = { $UserTable[$_.AssignedPstnTargetId.ToString()].UserPrincipalName } }

    # Export to CSV
    $csvPath = "C:\Temp\TeamsNumbers_All.csv"
    $Enriched | Export-Csv -Path $csvPath -NoTypeInformation

    ### Upload to SFTP instead of email ###
    Import-Module Posh-SSH

    $username = ""   # TODO: fill in
    $password = ""   # TODO: fill in (or read from a safe source)

    $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
    $credential     = New-Object System.Management.Automation.PSCredential ($username, $securePassword)

    $session = New-SFTPSession -ComputerName "Files.calero.com" -Port 22 -Credential $credential

    # Destination is the *folder*, not the full file path
    Set-SFTPItem -Path $csvPath `
                 -Destination "/ToCalero/Teams" `
                 -SessionId $session.SessionId `
                 -Force

    Remove-SFTPSession -SessionId $session.SessionId
}

catch {
    # Capture error details
    $errorText = $_ | Out-String
    Write-Error "An error occurred in the Teams report script: $errorText"

    # Try to send an email about the failure
    try {
        # Make sure Graph is connected (ignore failure here; we log in the inner catch)
        Connect-MgGraph -ErrorAction SilentlyContinue

        $from = ''  # UPN or user id that will send the error email
        $to   = ''  # Recipient of the error notification

        $subject = 'Teams phone numbers report FAILED'
        $bodyContent = @"
The Teams phone numbers report script encountered an error.

Error details:

$errorText
"@

        $body = @{
            contentType = "Text"
            content     = $bodyContent
        }

        $message = @{
            subject      = $subject
            body         = $body
            toRecipients = @(
                @{ emailAddress = @{ address = $to } }
            )
        }

        $bodyParam = @{ message = $message }

        Send-MgUserMail -UserId $from -BodyParameter $bodyParam -ErrorAction Stop
    }
    catch {
        Write-Error "Failed to send error notification email: $_"
    }
}
